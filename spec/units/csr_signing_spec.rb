require File.dirname(__FILE__) + '/units_helper'

describe "Signing a CSR" do
  before :all do
    ca_pem = <<_EOF_
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
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
fZfxEQ==
-----END CERTIFICATE-----
_EOF_

    csr_pem = <<_EOF_
-----BEGIN CERTIFICATE REQUEST-----
MIIBlDCB/gIBADBVMQswCQYDVQQGEwJBVTETMBEGA1UECBMKU29tZS1TdGF0ZTEh
MB8GA1UEChMYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMQ4wDAYDVQQDEwV1c2hl
cjCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAw9KX9VxqgcSIQhC2xYRY5woP
oHOGjNWbjq4kQE3kjKIPKXUOOsLZVp1EJKwm8ubnvqRZu6vP6X7n1qG/m09TkMZ8
Kr68Gyv8+aANwsndkbW2+HrRC71MyuQfWn1yO4E3Ga6y02KXZWR+UI/bDuflYZZ6
DA2zhxDKAtTY5515KTMCAwEAAaAAMA0GCSqGSIb3DQEBBQUAA4GBAAZ2pBN7LM1p
KKFq9OxbSpMPqWm4AOysVprSuliJudWx7lEqEqauYkX0o1wgn0QytClwtul5DAsb
N5/EyAV25DwZRnDVvnuc029LzNvAA8aQGdTo/xm9SyzTxK7Tr9Q8hyhVspVrzruJ
Vm3w8XSizTV4sqiE5HvfgI8nqsOP2AD0
-----END CERTIFICATE REQUEST-----
_EOF_

    @issuer = OpenSSL::X509::Certificate.new(ca_pem)
    issuer_ca = CertificateAuthority::Certificate.from_openssl(@issuer)
    issuer_ca.key_material.private_key = OpenSSL::PKey::RSA.new(ca_pem)

    csr = CertificateAuthority::SigningRequest.from_x509_csr(csr_pem)
    req = csr.to_cert
    req.parent = issuer_ca
    req.serial_number.number = 2

    req.sign!

    @issued = OpenSSL::X509::Certificate.new(req.to_pem)
  end

  it "should issue a certificate verified by the issuer" do
    @issued.verify(@issuer.public_key ).should be_true
  end

  it "should issue a certificate with a matching issuer subject string" do
    @issued.issuer.to_s.should == @issuer.subject.to_s
  end

  it "should issue a certificate with a matching issuer subject openssl name" do
    @issued.issuer.should == @issuer.subject
  end
end

